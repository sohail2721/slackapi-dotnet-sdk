// <copyright file="AuthorizationCodeAuthManager.cs" company="APIMatic">
// SlackWebApi.Standard
//
// This file was automatically generated by APIMATIC v3.0 ( https://www.apimatic.io ).
// </copyright>
using APIMatic.Core;
using APIMatic.Core.Authentication;
using APIMatic.Core.Utilities;
using SlackWebApi.Standard.Controllers;
using SlackWebApi.Standard.Exceptions;
using SlackWebApi.Standard.Models;
using System;
using System.Collections.Generic;
using System.Net.Http;
using System.Text;
using System.Threading.Tasks;

namespace SlackWebApi.Standard.Authentication
{
    /// <summary>
    /// AuthorizationCodeAuthManager Class.
    /// </summary>
    public class AuthorizationCodeAuthManager : AuthManager, IAuthorizationCodeAuth
    {
        private readonly Func<GlobalConfiguration> getGlobalConfiguration;
        private readonly Func<OauthAuthorizationController> getOAuthController;

        /// <summary>
        /// Initializes a new instance of the <see cref="AuthorizationCodeAuthManager"/> class.
        /// </summary>
        /// <param name="authorizationCodeAuth"> OAuth 2 Authorization Code Model.</param>
        /// <param name="getGlobalConfiguration">A function that provides an instance of <see cref="GlobalConfiguration"/>.</param>
        /// <param name="getOAuthController">A function that provides an instance of <see cref="OauthAuthorizationController"/>.</param>
        internal AuthorizationCodeAuthManager(AuthorizationCodeAuthModel authorizationCodeAuth,
            Func<GlobalConfiguration> getGlobalConfiguration, Func<OauthAuthorizationController> getOAuthController)
        {
            OauthClientId = authorizationCodeAuth?.OauthClientId;
            OauthClientSecret = authorizationCodeAuth?.OauthClientSecret;
            OauthRedirectUri = authorizationCodeAuth?.OauthRedirectUri;
            OauthToken = authorizationCodeAuth?.OauthToken;
            OauthScopes = authorizationCodeAuth?.OauthScopes;
            this.getGlobalConfiguration = getGlobalConfiguration;
            this.getOAuthController = getOAuthController;
            Parameters(authParameter => authParameter
                .Header(headerParameter => headerParameter
                    .Setup("Authorization",
                        OauthToken?.AccessToken == null ? null : $"Bearer {OauthToken?.AccessToken}"
                    ).Required()));
        }

        /// <summary>
        /// Gets string value for oauthClientId.
        /// </summary>
        public string OauthClientId { get; }

        /// <summary>
        /// Gets string value for oauthClientSecret.
        /// </summary>
        public string OauthClientSecret { get; }

        /// <summary>
        /// Gets string value for oauthRedirectUri.
        /// </summary>
        public string OauthRedirectUri { get; }

        /// <summary>
        /// Gets Models.OauthToken value for oauthToken.
        /// </summary>
        public Models.OauthToken OauthToken { get; }

        /// <summary>
        /// Gets List of Models.OauthScope value for oauthScopes.
        /// </summary>
        public List<Models.OauthScope> OauthScopes { get; }

        /// <summary>
        /// Check if credentials match.
        /// </summary>
        /// <param name="oauthClientId"> The string value for credentials.</param>
        /// <param name="oauthClientSecret"> The string value for credentials.</param>
        /// <param name="oauthRedirectUri"> The string value for credentials.</param>
        /// <param name="oauthToken"> The Models.OauthToken value for credentials.</param>
        /// <param name="oauthScopes"> The List of Models.OauthScope value for credentials.</param>
        /// <returns> True if credentials matched.</returns>
        public bool Equals(string oauthClientId, string oauthClientSecret, string oauthRedirectUri, Models.OauthToken oauthToken, List<Models.OauthScope> oauthScopes)
        {
            return oauthClientId.Equals(this.OauthClientId)
                    && oauthClientSecret.Equals(this.OauthClientSecret)
                    && oauthRedirectUri.Equals(this.OauthRedirectUri)
                    && ((oauthToken == null && this.OauthToken == null) || (oauthToken != null && this.OauthToken != null && oauthToken.Equals(this.OauthToken)))
                    && ((oauthScopes == null && this.OauthScopes == null) || (oauthScopes != null && this.OauthScopes != null && oauthScopes.Equals(this.OauthScopes)));
        }

        /// <summary>
        /// Fetch the OAuth token.
        /// </summary>
        /// <param name="authorizationCode">Authorization code returned by the OAuth provider.</param>
        /// <param name="additionalParameters">Dictionary of additional parameters.</param>
        /// <returns>Models.OauthToken.</returns>
        public Models.OauthToken FetchToken(string authorizationCode, Dictionary<string, object> additionalParameters = null)
            => CoreHelper.RunTask(FetchTokenAsync(authorizationCode, additionalParameters));

        /// <summary>
        /// Fetch the OAuth token asynchronously.
        /// </summary>
        /// <param name="authorizationCode">Authorization code returned by the OAuth provider.</param>
        /// <param name="additionalParameters">Dictionary of additional parameters.</param>
        /// <returns>Models.OauthToken.</returns>
        public async Task<Models.OauthToken> FetchTokenAsync(string authorizationCode, Dictionary<string, object> additionalParameters = null)
        {
            var token = await getOAuthController().RequestTokenAsync(BuildBasicAuthHeader(), authorizationCode, OAuthRedirectUri, additionalParameters).ConfigureAwait(false);

            if (token.Data.ExpiresIn != null && token.Data.ExpiresIn != 0)
            {
                token.Data.Expiry = (long)DateTime.UtcNow.Subtract(new DateTime(1970, 1, 1)).TotalSeconds + token.Data.ExpiresIn;
            }

            return token.Data;
        }
        
        /// <summary>
        /// Checks if token is expired.
        /// </summary>
        /// <returns> Returns true if token is expired.</returns>
        public bool IsTokenExpired()
        {
           if (this.OauthToken == null)
           {
               throw new InvalidOperationException("OAuth token is missing.");
           }
        
           return this.OauthToken.Expiry != null
               && this.OauthToken.Expiry < (long)DateTime.UtcNow.Subtract(new DateTime(1970, 1, 1)).TotalSeconds;
        }

        /// <summary>
        /// Refresh the OAuth token asynchronously.
        /// </summary>
        /// <param name="additionalParameters">Dictionary of additional parameters.</param>
        /// <returns>Models.OauthToken.</returns>
        public async Task<Models.OauthToken> RefreshTokenAsync(Dictionary<string, object> additionalParameters = null)
        {
            var token = await getOAuthController().RefreshTokenAsync(BuildBasicAuthHeader(), this.OauthToken.RefreshToken, this.OauthScopes.GetValues(), additionalParameters).ConfigureAwait(false);
            return token.Data;
        }

        /// <summary>
        /// Refresh the OAuth token.
        /// </summary>
        /// <param name="additionalParameters">Dictionary of additional parameters.</param>
        /// <returns>Models.OauthToken.</returns>
        public Models.OauthToken RefreshToken(Dictionary<string, object> additionalParameters = null)
            => CoreHelper.RunTask(RefreshTokenAsync(additionalParameters));
        

        /// <summary>
        /// Builds the authorization url for making authorized calls.
        /// </summary>
        /// <param name="state">State</param>        
        /// <param name="additionalParameters">Additional parameters to be appended</param>        
        public async Task<string> BuildAuthorizationUrl(string state = null, Dictionary<string, object> additionalParameters = null)
        {
            var request = await getGlobalConfiguration().GlobalRequestBuilder(Server.AuthServer)
              .Setup(HttpMethod.Get, "/authorize")
              .Parameters(parameter => parameter
                .Query(queryParameter => queryParameter.Setup("response_type", "code"))
                .Query(queryParameter => queryParameter.Setup("client_id", OauthClientId))
                .Query(queryParameter => queryParameter.Setup("redirect_uri", OauthRedirectUri))
                .Query(queryParameter => queryParameter.Setup("scope", OauthScopes.GetValues()))
                .Query(queryParameter => queryParameter.Setup("state", state))
                .AdditionalQueries(additionalQuery => additionalQuery.Setup(additionalParameters)))
              .Build().ConfigureAwait(false);
            return request.QueryUrl;
        }

        /// <summary>
        /// Validates the authentication parameters for the HTTP Request.
        /// </summary>
        public override void Validate()
        {
            base.Validate();
            if (OauthToken == null)
            {
                throw new ApiException(
                        "Client is not authorized.An OAuth token is needed to make API calls.");
            }

            if (IsTokenExpired())
            {
                throw new ApiException(
                        "OAuth token is expired. A valid token is needed to make API calls.");
            }
        }


        /// <summary>
        /// Build basic auth header.
        /// </summary>
        /// <returns> string. </returns>
        private string BuildBasicAuthHeader()
        {
            var plainTextBytes = Encoding.UTF8.GetBytes(this.OauthClientId + ':' + this.OauthClientSecret);
            return "Basic " + Convert.ToBase64String(plainTextBytes);
        }
    }

    public sealed class AuthorizationCodeAuthModel
    {
        internal AuthorizationCodeAuthModel()
        {
        }

        internal string OauthClientId { get; set; }

        internal string OauthClientSecret { get; set; }

        internal string OauthRedirectUri { get; set; }

        internal Models.OauthToken OauthToken { get; set; }

        internal List<Models.OauthScope> OauthScopes { get; set; }

        /// <summary>
        /// Creates an object of the AuthorizationCodeAuthModel using the values provided for the builder.
        /// </summary>
        /// <returns>Builder.</returns>
        public Builder ToBuilder()
        {
            return new Builder(OauthClientId, OauthClientSecret, OauthRedirectUri)
                .OauthToken(OauthToken)
                .OauthScopes(OauthScopes);
        }

        /// <summary>
        /// Builder class for AuthorizationCodeAuthModel.
        /// </summary>
        public class Builder
        {
            private string oauthClientId;
            private string oauthClientSecret;
            private string oauthRedirectUri;
            private Models.OauthToken oauthToken;
            private List<Models.OauthScope> oauthScopes;

            public Builder(string oauthClientId, string oauthClientSecret, string oauthRedirectUri)
            {
                this.oauthClientId = oauthClientId ?? throw new ArgumentNullException(nameof(oauthClientId));
                this.oauthClientSecret = oauthClientSecret ?? throw new ArgumentNullException(nameof(oauthClientSecret));
                this.oauthRedirectUri = oauthRedirectUri ?? throw new ArgumentNullException(nameof(oauthRedirectUri));
            }

            /// <summary>
            /// Sets OauthClientId.
            /// </summary>
            /// <param name="oauthClientId">OauthClientId.</param>
            /// <returns>Builder.</returns>
            public Builder OauthClientId(string oauthClientId)
            {
                this.oauthClientId = oauthClientId ?? throw new ArgumentNullException(nameof(oauthClientId));
                return this;
            }

            /// <summary>
            /// Sets OauthClientSecret.
            /// </summary>
            /// <param name="oauthClientSecret">OauthClientSecret.</param>
            /// <returns>Builder.</returns>
            public Builder OauthClientSecret(string oauthClientSecret)
            {
                this.oauthClientSecret = oauthClientSecret ?? throw new ArgumentNullException(nameof(oauthClientSecret));
                return this;
            }

            /// <summary>
            /// Sets OauthRedirectUri.
            /// </summary>
            /// <param name="oauthRedirectUri">OauthRedirectUri.</param>
            /// <returns>Builder.</returns>
            public Builder OauthRedirectUri(string oauthRedirectUri)
            {
                this.oauthRedirectUri = oauthRedirectUri ?? throw new ArgumentNullException(nameof(oauthRedirectUri));
                return this;
            }

            /// <summary>
            /// Sets OauthToken.
            /// </summary>
            /// <param name="oauthToken">OauthToken.</param>
            /// <returns>Builder.</returns>
            public Builder OauthToken(Models.OauthToken oauthToken)
            {
                this.oauthToken = oauthToken;
                return this;
            }

            /// <summary>
            /// Sets OauthScopes.
            /// </summary>
            /// <param name="oauthScopes">OauthScopes.</param>
            /// <returns>Builder.</returns>
            public Builder OauthScopes(List<Models.OauthScope> oauthScopes)
            {
                this.oauthScopes = oauthScopes;
                return this;
            }

            /// <summary>
            /// Creates an object of the AuthorizationCodeAuthModel using the values provided for the builder.
            /// </summary>
            /// <returns>AuthorizationCodeAuthModel.</returns>
            public AuthorizationCodeAuthModel Build()
            {
                return new AuthorizationCodeAuthModel()
                {
                    OauthClientId = this.oauthClientId,
                    OauthClientSecret = this.oauthClientSecret,
                    OauthRedirectUri = this.oauthRedirectUri,
                    OauthToken = this.oauthToken,
                    OauthScopes = this.oauthScopes
                };
            }
        }

        internal static AuthorizationCodeAuthModel FromOptions(AuthorizationCodeAuthModelOptions options)
        {
            var builder = new Builder(options.OauthClientId, options.OauthClientSecret, options.OauthRedirectUri);
            if (options.OauthToken != null)
                builder.OauthToken(options.OauthToken);
            if (options.OauthScopes != null)
                builder.OauthScopes(options.OauthScopes);
            return builder.Build();
        }
    }

    public class AuthorizationCodeAuthModelOptions
    {
        public string OauthClientId { get; set; }
        public string OauthClientSecret { get; set; }
        public string OauthRedirectUri { get; set; }
        public Models.OauthToken OauthToken { get; set; }
        public List<Models.OauthScope> OauthScopes { get; set; }
    }
}